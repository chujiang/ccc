<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TestGroup">
  <resultMap id="BaseResultMap" type="com.kingnod.etraining.exam.entity.TestGroup">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    <id column="A_ID" jdbcType="DECIMAL" property="id" />
    <result column="A_NAME" jdbcType="VARCHAR" property="name" />
    <result column="A_EXAM_PAPER_ID" jdbcType="DECIMAL" property="examPaperId" />
    <result column="A_GROUP_SEQ" jdbcType="DECIMAL" property="groupSeq" />
    <result column="A_QUESTION_TYPE" jdbcType="CHAR" property="questionType" />
    <result column="A_READING_TYPE" jdbcType="CHAR" property="readingType" />
    <result column="A_STATUS" jdbcType="CHAR" property="status" />
    <result column="A_RECORD_STATUS" jdbcType="CHAR" property="recordStatus" />
    <result column="A_UPDATE_COUNT" jdbcType="DECIMAL" property="updateCount" />
    <result column="A_CREATOR_ID" jdbcType="DECIMAL" property="creatorId" />
    <result column="A_CREATE_DATE" jdbcType="TIMESTAMP" property="createDate" />
    <result column="A_UPDATER_ID" jdbcType="DECIMAL" property="updaterId" />
    <result column="A_UPDATE_DATE" jdbcType="TIMESTAMP" property="updateDate" />
    <result column="A_SCORE" jdbcType="DECIMAL" property="score" />
    <result column="A_QUESTION_NUMBER" jdbcType="DECIMAL" property="questionNumber" />
    <result column="A_GENERATOR_PAPER_PATTERN" jdbcType="CHAR" property="generatorPaperPattern" />
    <result column="A_EXTRACTING_QUESTION_WAY" jdbcType="CHAR" property="extractingQuestionWay" />
    <result column="A_DESCRIPTION" jdbcType="VARCHAR" property="description" />
    <collection column="A_ID" property="questionList" select="QuestionTestGroup.findListByTestGroupId" />
    <collection column="A_ID" property="questionTestGroups" select="QuestionTestGroup.findListByQuestionTestGroup" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    A.ID as A_ID, A.NAME as A_NAME, A.EXAM_PAPER_ID as A_EXAM_PAPER_ID, A.GROUP_SEQ as A_GROUP_SEQ, 
    A.QUESTION_TYPE as A_QUESTION_TYPE, A.READING_TYPE as A_READING_TYPE, A.STATUS as A_STATUS, 
    A.RECORD_STATUS as A_RECORD_STATUS, A.UPDATE_COUNT as A_UPDATE_COUNT, A.CREATOR_ID as A_CREATOR_ID, 
    A.CREATE_DATE as A_CREATE_DATE, A.UPDATER_ID as A_UPDATER_ID, A.UPDATE_DATE as A_UPDATE_DATE, 
    A.SCORE as A_SCORE, A.QUESTION_NUMBER as A_QUESTION_NUMBER, A.GENERATOR_PAPER_PATTERN as A_GENERATOR_PAPER_PATTERN, 
    A.EXTRACTING_QUESTION_WAY as A_EXTRACTING_QUESTION_WAY, A.DESCRIPTION as A_DESCRIPTION
  </sql>
  <select id="findByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    select
    <include refid="Base_Column_List" />
     from EXM_TEST_GROUP A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  <select id="findById" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    select 
    <include refid="Base_Column_List" />
    from EXM_TEST_GROUP A
    where A.ID = #{id,jdbcType=DECIMAL}
  </select>
  <delete id="deleteById" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    delete from EXM_TEST_GROUP
    where ID = #{id,jdbcType=DECIMAL}
  </delete>
  <delete id="deleteByCriteria" parameterType="com.kingnod.core.criteria.Criteria">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    delete A from EXM_TEST_GROUP A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
  </delete>
  <insert id="insert" parameterType="com.kingnod.etraining.exam.entity.TestGroup">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      select LAST_INSERT_ID()
    </selectKey>
    insert into EXM_TEST_GROUP (NAME, EXAM_PAPER_ID, 
      GROUP_SEQ, QUESTION_TYPE, READING_TYPE, 
      STATUS, RECORD_STATUS, UPDATE_COUNT, 
      CREATOR_ID, CREATE_DATE, UPDATER_ID, 
      UPDATE_DATE, SCORE, QUESTION_NUMBER, 
      GENERATOR_PAPER_PATTERN, EXTRACTING_QUESTION_WAY, 
      DESCRIPTION)
    values (#{name,jdbcType=VARCHAR}, #{examPaperId,jdbcType=DECIMAL}, 
      #{groupSeq,jdbcType=DECIMAL}, #{questionType,jdbcType=CHAR}, #{readingType,jdbcType=CHAR}, 
      #{status,jdbcType=CHAR}, #{recordStatus,jdbcType=CHAR}, #{updateCount,jdbcType=DECIMAL}, 
      #{creatorId,jdbcType=DECIMAL}, #{createDate,jdbcType=TIMESTAMP}, #{updaterId,jdbcType=DECIMAL}, 
      #{updateDate,jdbcType=TIMESTAMP}, #{score,jdbcType=DECIMAL}, #{questionNumber,jdbcType=DECIMAL}, 
      #{generatorPaperPattern,jdbcType=CHAR}, #{extractingQuestionWay,jdbcType=CHAR}, 
      #{description,jdbcType=VARCHAR})
  </insert>
  <select id="countByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    select count(ID) from EXM_TEST_GROUP A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
  </select>
  <update id="updateByCriteria" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    update EXM_TEST_GROUP A
    <set>
      <if test="record.id != null">
        A.ID = #{record.id,jdbcType=DECIMAL},
      </if>
      <if test="record.name != null">
        A.NAME = #{record.name,jdbcType=VARCHAR},
      </if>
      <if test="record.examPaperId != null">
        A.EXAM_PAPER_ID = #{record.examPaperId,jdbcType=DECIMAL},
      </if>
      <if test="record.groupSeq != null">
        A.GROUP_SEQ = #{record.groupSeq,jdbcType=DECIMAL},
      </if>
      <if test="record.questionType != null">
        A.QUESTION_TYPE = #{record.questionType,jdbcType=CHAR},
      </if>
      <if test="record.readingType != null">
        A.READING_TYPE = #{record.readingType,jdbcType=CHAR},
      </if>
      <if test="record.status != null">
        A.STATUS = #{record.status,jdbcType=CHAR},
      </if>
      <if test="record.recordStatus != null">
        A.RECORD_STATUS = #{record.recordStatus,jdbcType=CHAR},
      </if>
      <if test="record.updateCount != null">
        A.UPDATE_COUNT = #{record.updateCount,jdbcType=DECIMAL},
      </if>
      <if test="record.creatorId != null">
        A.CREATOR_ID = #{record.creatorId,jdbcType=DECIMAL},
      </if>
      <if test="record.createDate != null">
        A.CREATE_DATE = #{record.createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.updaterId != null">
        A.UPDATER_ID = #{record.updaterId,jdbcType=DECIMAL},
      </if>
      <if test="record.updateDate != null">
        A.UPDATE_DATE = #{record.updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.score != null">
        A.SCORE = #{record.score,jdbcType=DECIMAL},
      </if>
      <if test="record.questionNumber != null">
        A.QUESTION_NUMBER = #{record.questionNumber,jdbcType=DECIMAL},
      </if>
      <if test="record.generatorPaperPattern != null">
        A.GENERATOR_PAPER_PATTERN = #{record.generatorPaperPattern,jdbcType=CHAR},
      </if>
      <if test="record.extractingQuestionWay != null">
        A.EXTRACTING_QUESTION_WAY = #{record.extractingQuestionWay,jdbcType=CHAR},
      </if>
      <if test="record.description != null">
        A.DESCRIPTION = #{record.description,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
  </update>
  <update id="update" parameterType="com.kingnod.etraining.exam.entity.TestGroup">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-06-11 11:45.
    -->
    update EXM_TEST_GROUP A
    <set>
      <if test="id != null">
        A.ID = #{id,jdbcType=DECIMAL},
      </if>
      <if test="name != null">
        A.NAME = #{name,jdbcType=VARCHAR},
      </if>
      <if test="examPaperId != null">
        A.EXAM_PAPER_ID = #{examPaperId,jdbcType=DECIMAL},
      </if>
      <if test="groupSeq != null">
        A.GROUP_SEQ = #{groupSeq,jdbcType=DECIMAL},
      </if>
      <if test="questionType != null">
        A.QUESTION_TYPE = #{questionType,jdbcType=CHAR},
      </if>
      <if test="readingType != null">
        A.READING_TYPE = #{readingType,jdbcType=CHAR},
      </if>
      <if test="status != null">
        A.STATUS = #{status,jdbcType=CHAR},
      </if>
      <if test="recordStatus != null">
        A.RECORD_STATUS = #{recordStatus,jdbcType=CHAR},
      </if>
      <if test="updateCount != null">
        A.UPDATE_COUNT = #{updateCount,jdbcType=DECIMAL},
      </if>
      <if test="creatorId != null">
        A.CREATOR_ID = #{creatorId,jdbcType=DECIMAL},
      </if>
      <if test="createDate != null">
        A.CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updaterId != null">
        A.UPDATER_ID = #{updaterId,jdbcType=DECIMAL},
      </if>
      <if test="updateDate != null">
        A.UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="score != null">
        A.SCORE = #{score,jdbcType=DECIMAL},
      </if>
      <if test="questionNumber != null">
        A.QUESTION_NUMBER = #{questionNumber,jdbcType=DECIMAL},
      </if>
      <if test="generatorPaperPattern != null">
        A.GENERATOR_PAPER_PATTERN = #{generatorPaperPattern,jdbcType=CHAR},
      </if>
      <if test="extractingQuestionWay != null">
        A.EXTRACTING_QUESTION_WAY = #{extractingQuestionWay,jdbcType=CHAR},
      </if>
      <if test="description != null">
        A.DESCRIPTION = #{description,jdbcType=VARCHAR},
      </if>
    </set>
    where A.ID = #{id,jdbcType=DECIMAL}
  </update>
  
  <select id="findMaxByGroupSeq" parameterType="java.lang.Long" resultType="java.lang.Integer">
  	<!--
      WARNING - @自定义
    -->
    SELECT MAX(GROUP_SEQ) as groupSeq FROM EXM_TEST_GROUP WHERE EXAM_PAPER_ID = #{examPaperId,jdbcType=DECIMAL} AND RECORD_STATUS = 'A'
    
  </select>
  
  <select id="findByGroupSeq" parameterType="com.kingnod.etraining.exam.entity.QuestionTestGroup" resultMap="BaseResultMap">
    <!--
      WARNING - @自定义
    -->
    select * 
    from (
	select * 
	from EXM_TEST_GROUP 
	where 
	<if test="upOrDown == 0">
		<![CDATA[
			GROUP_SEQ < #{groupSeq,jdbcType=DECIMAL} order by GROUP_SEQ desc
		]]>
	</if>
	<if test="upOrDown == 1">
		<![CDATA[
			GROUP_SEQ > #{groupSeq,jdbcType=DECIMAL} order by GROUP_SEQ
		]]>
	</if>
	<if test="upOrDown == 2">
		<![CDATA[
			GROUP_SEQ < #{groupSeq,jdbcType=DECIMAL} order by GROUP_SEQ
		]]>
	</if>
	<if test="upOrDown == 3">
		<![CDATA[
			GROUP_SEQ > #{groupSeq,jdbcType=DECIMAL} order by GROUP_SEQ desc
		]]>
	</if>
	) 
	where rownum = 1 AND RECORD_STATUS = 'A'
  </select>
  
  <update id="updateAllGroupSeqes" parameterType="com.kingnod.etraining.exam.entity.QuestionTestGroup">
	  <if test="upOrDown == 2">
	  	<![CDATA[
	  		update EXM_TEST_GROUP A set A.GROUP_SEQ = GROUP_SEQ + #{groupSeq,jdbcType=DECIMAL} where id <> #{id,jdbcType=DECIMAL}
	  		and A.GROUP_SEQ < #{newGroupSeq,jdbcType=DECIMAL}
	  	]]>
	  </if>
	  <if test="upOrDown == 3">
	  	<![CDATA[
	  		update EXM_TEST_GROUP A set A.GROUP_SEQ = GROUP_SEQ - #{groupSeq,jdbcType=DECIMAL} where id <> #{id,jdbcType=DECIMAL}
	  		and A.GROUP_SEQ > #{newGroupSeq,jdbcType=DECIMAL}
	  	]]>
	  </if>
  </update>
  
  <select id="findBytestGroupIds" parameterType="com.kingnod.core.criteria.Criteria" resultMap="BaseResultMap">
    <!--
      WARNING - @自定义
    -->
    select * from EXM_TEST_GROUP A
    <if test="_parameter != null">
      <where><include refid="Global.Where_Clause" /></where>
    </if>
    AND A.RECORD_STATUS = 'A'
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  
  <select id="findSocreAndQuestionNumber" parameterType="java.lang.Long" resultType="com.kingnod.etraining.exam.entity.TestGroup">
	SELECT A.ID,A.NAME,A.QUESTION_TYPE,A.SCORE,A.QUESTION_NUMBER,
		   SUM(CASE WHEN B.SCORE IS NOT NULL THEN B.SCORE ELSE 0 END) AS TOTALSCORE,
		   COUNT(A.ID) AS alreadyAddQuestionNumber
	FROM EXM_TEST_GROUP A, EXM_QUESTION_TEST_GROUP B
	WHERE A.ID = B.TEST_GROUP_ID AND A.ID = #{id,jdbcType=DECIMAL} AND A.RECORD_STATUS = 'A' AND B.RECORD_STATUS = 'A'
	GROUP BY A.ID,A.NAME,A.QUESTION_TYPE,A.SCORE,A.QUESTION_NUMBER
  </select>
  
  <select id="findPaperNameByPaperId" parameterType="java.lang.Long" resultType="java.lang.String">
  <!-- 自定义   获取试卷名称 -->
  	SELECT A.NAME FROM EXM_EXAM_PAPER A WHERE A.ID = #{examPaperId,jdbcType=DECIMAL} AND A.RECORD_STATUS = 'A'
  </select>
  
  <select id="findTestTotalScoreByPaperId" parameterType="map" resultType="java.lang.Integer">
  	<!-- 自定义   查询试卷下  所有测试区的总分数 -->
  	SELECT IFNULL(SUM(A.SCORE),0) FROM EXM_TEST_GROUP A WHERE A.EXAM_PAPER_ID = #{examPaperId,jdbcType=DECIMAL} AND A.RECORD_STATUS = 'A'
  	<if test="readingType != null">
  		<if test="'' != readingType">
  			AND A.READING_TYPE ='${readingType}'
  		</if>
  	</if>
  </select>
  
  <select id="findPaPerTestGroupByExamId" parameterType="java.lang.Long" resultMap="BaseResultMap">
  	<!-- 自定义   查询试卷下  所有测试区 -->
  	select <include refid="Base_Column_List" /> from exm_test_group A where record_status = 'A' and exam_paper_id = 
  	(select aty_paper_id from aty_examination where id = #{examId} and record_status = 'A') order by group_seq
  </select>
  
  <select id="findPaPerTestGroupByPaperId" parameterType="java.lang.Long" resultMap="BaseResultMap">
  	<!-- 自定义   查询试卷下  所有测试区 -->
  	select <include refid="Base_Column_List" /> from exm_test_group A where record_status = 'A' and exam_paper_id = #{paperId} order by group_seq
  </select>
  
  <select id="findAlreadyGeneratedQuestions" parameterType="com.kingnod.etraining.activity.entity.ExamineesHistory" resultMap="BaseResultMap">
  	<!-- @自定义  查询已经生成试题的测试区 -->
	SELECT 
	 <include refid="Base_Column_List" />
	 FROM EXM_TEST_GROUP A
	WHERE A.ID IN (
	SELECT DISTINCT(B.TEST_GROUP_ID) FROM EXM_EXAMINEE_QUESTION B WHERE B.EXAM_PAPER_ID = #{atyPaperId,jdbcType=DECIMAL}
	   AND B.EXAMINATION_ID = #{examinationId,jdbcType=DECIMAL}
	   AND B.USER_ID = #{userId,jdbcType=DECIMAL}
	   AND B.EXAM_NUMBER = #{times,jdbcType=DECIMAL})
  </select>
  
  <select id="findAllQuestionId" parameterType="com.kingnod.etraining.exam.entity.TestGroup" resultMap="questionIdResult">
	<!-- @自定义  查询当前题纲下所有的试题ID -->
	SELECT A.QUESTION_ID
	  FROM EXM_QUESTION_TEST_GROUP A
	 WHERE A.RECORD_STATUS = 'A'
	 	<if test="null != examPaperId">
	 		AND A.EXAM_PAPER_ID = #{examPaperId,jdbcType=DECIMAL}
	 	</if>
	 	<if test="null != id">
	 		AND A.TEST_GROUP_ID = #{id,jdbcType=DECIMAL}
	 	</if>
  </select>
  
  <resultMap type="java.lang.Long" id="questionIdResult">
  	<id column="QUESTION_ID" javaType="java.lang.Long" property="id"/>
  </resultMap>
  
</mapper>