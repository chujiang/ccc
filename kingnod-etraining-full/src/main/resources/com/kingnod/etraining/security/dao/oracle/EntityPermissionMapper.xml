<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EntityPermission">
  <resultMap id="BaseResultMap" type="com.kingnod.etraining.security.entity.EntityPermission">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
    <result column="A_ENTITY_ID" jdbcType="DECIMAL" property="entityId" />
    <result column="A_ENTITY_TYPE" jdbcType="VARCHAR" property="entityType" />
    <result column="A_OWNER_TYPE" jdbcType="CHAR" property="ownerType" />
    <result column="A_OWNER_ID" jdbcType="DECIMAL" property="ownerId" />
    <result column="A_PERMISSION_VALUE" jdbcType="DECIMAL" property="permissionValue" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
    A.ENTITY_ID as A_ENTITY_ID, A.ENTITY_TYPE as A_ENTITY_TYPE, A.OWNER_TYPE as A_OWNER_TYPE, 
    A.OWNER_ID as A_OWNER_ID, A.PERMISSION_VALUE as A_PERMISSION_VALUE
  </sql>
  <select id="findPermByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="BaseResultMap">
    <!--
      WARNING - @自定义
    -->
     select <include refid="Base_Column_List" />
     from SYS_ENTITY_PERMISSION A, 
     (select id, type from ${params.entityTable} start with id = #{params.entityId} and type= #{params.entityType} connect by prior parent_id = id) B 
     where A.entity_id = B.id  and (a.entity_type = b.type or a.entity_type = #{params.entityType} )
    <if test="params != null">
      and A.PERMISSION_VALUE>0 and (
      <if test="params.userPermission != null">
      	<foreach collection="params.userPermission.conditions" open="(" close=")" item="perCnd">
      		 ${perCnd.expression} #{perCnd.value} 
      	</foreach>
      </if>
	       
      <if test="params.groupPermission != null">
      <if test="params.userPermission != null">
      OR 
      </if>
      <foreach collection="params.groupPermission.conditions" open="(" close=")" item="perCnd">
      	<if test="perCnd.group">
      		${perCnd.logic} 
      		<foreach close=")" collection="perCnd.all" item="perCndNest" open="(">
      			${perCndNest.expression} ${perCndNest.value} 
      		</foreach>
      	</if>
      	<if test="perCnd.group == false">
      		${perCnd.expression} #{perCnd.value} 
      	</if>
      </foreach>
      </if>
      )
	</if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  
  <select id="findUserPermByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="BaseResultMap">
    <!--
      WARNING - @自定义
    -->
     select <include refid="Base_Column_List" />
     from SYS_ENTITY_PERMISSION A, 
     (select id, type from ${params.entityTable} start with id = #{params.entityId} and type= #{params.entityType} connect by prior parent_id = id) B 
     where A.entity_id = B.id and (a.entity_type = b.type or a.entity_type = #{params.entityType} )and A.PERMISSION_VALUE>0  
      and ( (A.OWNER_TYPE = 'U' and A.OWNER_ID = #{params.ownerId}) 
      	OR (A.OWNER_TYPE = 'G' and A.OWNER_ID IN (SELECT USER_GROUP_ID FROM ORG_USER_GROUP_USERS WHERE USER_ID = #{params.ownerId}))
      )
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  <delete id="deleteByCriteria" parameterType="com.kingnod.core.criteria.Criteria">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
    delete from SYS_ENTITY_PERMISSION A
    <if test="_parameter != null">
      <where><include refid="Global.Where_Clause" /></where>
    </if>
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
  </delete>
  <insert id="insert" parameterType="com.kingnod.etraining.security.entity.EntityPermission">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
    insert into SYS_ENTITY_PERMISSION (ENTITY_ID, ENTITY_TYPE, OWNER_TYPE, 
      OWNER_ID, PERMISSION_VALUE)
    values (#{entityId,jdbcType=DECIMAL}, #{entityType,jdbcType=VARCHAR}, #{ownerType,jdbcType=CHAR}, 
      #{ownerId,jdbcType=DECIMAL}, #{permissionValue,jdbcType=DECIMAL})
  </insert>
  <select id="countByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
    select count(*) from SYS_ENTITY_PERMISSION A
    <if test="_parameter != null">
      <where><include refid="Global.Where_Clause" /></where>
    </if>
  </select>
  <update id="updateByCriteria" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-03-28 11:42.
    -->
    update SYS_ENTITY_PERMISSION A
    <set>
      <if test="record.entityId != null">
        A.ENTITY_ID = #{record.entityId,jdbcType=DECIMAL},
      </if>
      <if test="record.entityType != null">
        A.ENTITY_TYPE = #{record.entityType,jdbcType=VARCHAR},
      </if>
      <if test="record.ownerType != null">
        A.OWNER_TYPE = #{record.ownerType,jdbcType=CHAR},
      </if>
      <if test="record.ownerId != null">
        A.OWNER_ID = #{record.ownerId,jdbcType=DECIMAL},
      </if>
      <if test="record.permissionValue != null">
        A.PERMISSION_VALUE = #{record.permissionValue,jdbcType=DECIMAL},
      </if>
    </set>
    <if test="_parameter != null">
      <where><include refid="Global.Where_Clause" /></where>
    </if>
  </update>
  
  <select id="selectPermissionByOwner" parameterType="java.util.Map" resultType="com.kingnod.etraining.security.entity.EntityPermission">
    <!-- WARNING - @自定义 查询当前用户是否拥有某个权限，附带查出当前用户所在的用户组和角色的所有权限 -->
      select * from sys_entity_permission 
      <where>  
      and  ENTITY_ID IN 
	   	<foreach collection="entityIds" open="(" close=")" item="entityId" separator=",">
	   		 #{entityId}
	   	</foreach>     	 
      and ENTITY_TYPE=#{entityType}
      and BITAND(PERMISSION_VALUE,${permValue})>0
      
      <if test="@com.kingnod.core.util.StringUtils@equals(ownerType,'U')">
      and	(
      		(owner_type = 'G' and owner_id in (select user_group_id from org_user_group_users where user_id = #{ownerId})) 
			or (owner_type = 'R' and owner_id in (select role_id from sys_role_ref where owner_id = #{ownerId})) 
			or (owner_type = 'U' and owner_id = #{ownerId})
		) 
	  </if>
	  <if test="@com.kingnod.core.util.StringUtils@equals(ownerType,'G')">
	  and owner_type='G' and owner_id=#{ownerId}
	  </if>
	  <if test="@com.kingnod.core.util.StringUtils@equals(ownerType,'R')">
	  and owner_type='R' and owner_id=#{ownerId}
	  </if> 
      </where>
      
       
      
  </select>
  
  <select id="selectOnePermissionByOwner" parameterType="java.util.Map" resultType="com.kingnod.etraining.security.entity.EntityPermission">
    <!-- WARNING - @自定义 查询当前用户是否拥有某个权限，附带查出当前用户所在的用户组和角色的所有权限 -->
      SELECT * FROM SYS_ENTITY_PERMISSION A, 
      (SELECT ID, TYPE FROM ${entityTable} START WITH ID = #{entityId} AND TYPE= #{entityType} CONNECT BY PRIOR PARENT_ID = ID) B 
      <where>  
	  A.entity_id = B.ID  and (a.entity_type = b.type or a.entity_type = #{entityType}) and 
	  ( (a.entity_type = #{entityType} and bitand(A.PERMISSION_VALUE, ${permValue}) > 0 ) or (a.entity_type &lt;&gt; #{entityType} and bitand(bitand(A.PERMISSION_VALUE, ${commonPermTotalValue}), ${permValue}) > 0) )
      <if test="@com.kingnod.core.util.StringUtils@equals(ownerType,'U')">
      AND	(
      		(A.OWNER_TYPE = 'G' AND A.OWNER_ID IN (SELECT USER_GROUP_ID FROM ORG_USER_GROUP_USERS WHERE USER_ID = #{ownerId})) 
			OR (OWNER_TYPE = 'U' AND OWNER_ID = #{ownerId})
		) 
	  </if>
	  <if test="@com.kingnod.core.util.StringUtils@equals(ownerType,'G')">
	  AND OWNER_TYPE='G' AND OWNER_ID=#{ownerId}
	  </if>
	  <if test="@com.kingnod.core.util.StringUtils@equals(ownerType,'R')">
	  AND OWNER_TYPE='R' AND OWNER_ID=#{ownerId}
	  </if> 
      </where>
      
       
      
  </select>

  <select id="getPermissionByEntityId" parameterType="java.lang.Long" resultType="com.kingnod.etraining.security.entity.EntityPermission">
    <!-- WARNING - @自定义  根据entityId查询 -->
    select * from sys_entity_permission where entity_id = #{entityId}
  </select>
  
  <select id="getPermissionByOwner" parameterType="com.kingnod.etraining.security.entity.EntityPermission" resultMap="BaseResultMap">
    <!-- WARNING - @自定义  根据角色查询权限 -->
   	SELECT * FROM SYS_ENTITY_PERMISSION A 
   	<where> 
	   	<if test="entityId != null">
	     AND A.ENTITY_ID = #{entityId}
	    </if>
	   	<if test="ownerId != null">
	     AND A.OWNER_ID = #{ownerId}
	    </if>
	   	<if test="ownerType != null">
	      AND A.OWNER_TYPE = '${ownerType}'
	    </if>
	    <if test="ownerType != null">
	      AND A.ENTITY_TYPE = '${entityType}'
	    </if>
    </where>
  </select>
  
  <insert id="insertEntityPermission" parameterType="com.kingnod.etraining.security.entity.EntityPermission">
    <!--
      WARNING - @自定义  添加权限
    -->
    insert into SYS_ENTITY_PERMISSION (ENTITY_ID, ENTITY_TYPE, OWNER_TYPE, OWNER_ID, PERMISSION_VALUE)
    values 
    (#{entityId,jdbcType=DECIMAL}, #{entityType,jdbcType=CHAR}, #{ownerType,jdbcType=CHAR},#{ownerId,jdbcType=DECIMAL}, #{permissionValue,jdbcType=DECIMAL})
  </insert>
  
  <update id="updatePermission" parameterType="com.kingnod.etraining.security.entity.EntityPermission">
    <!--
      WARNING - @自定义  修改权限
    -->
    update sys_entity_permission set permission_value = '${permissionValue}' where owner_id = #{ownerId,jdbcType=DECIMAL} and owner_type = '${ownerType}' and entity_id = #{entityId,jdbcType=DECIMAL}
  </update>
   
  <update id="updateEntityPermission" parameterType="com.kingnod.etraining.security.entity.EntityPermission">
    <!--
      WARNING - @自定义  修改权限
    -->
    update SYS_ENTITY_PERMISSION A
    <set>
      <if test="record.entityId != null">
        A.ENTITY_ID = #{record.entityId,jdbcType=DECIMAL},
      </if>
      <if test="record.entityType != null">
        A.ENTITY_TYPE = #{record.entityType,jdbcType=CHAR},
      </if>
      <if test="record.ownerType != null">
        A.OWNER_TYPE = #{record.ownerType,jdbcType=CHAR},
      </if>
      <if test="record.ownerId != null">
        A.OWNER_ID = #{record.ownerId,jdbcType=DECIMAL},
      </if>
      <if test="record.intValue != null">
        A.INT_VALUE = #{record.intValue,jdbcType=DECIMAL},
      </if>
      <if test="record.bitValue != null">
        A.BIT_VALUE = #{record.bitValue,jdbcType=CHAR},
      </if>
    </set>
    <if test="_parameter != null">
      <where><include refid="Global.Where_Clause" /></where>
    </if>
  </update>
  
  <delete id="deleteEntityPermission" parameterType="java.lang.Long">
    <!--
      WARNING - @自定义  删除权限
    -->
    delete from SYS_ENTITY_PERMISSION where entity_id = #{entityId,jdbcType=DECIMAL};
  </delete>
</mapper>