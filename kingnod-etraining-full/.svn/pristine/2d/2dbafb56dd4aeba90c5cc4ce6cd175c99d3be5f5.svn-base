<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserActivity">
  <resultMap id="BaseResultMap" type="com.kingnod.etraining.activity.entity.UserActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    <result column="A_ID" jdbcType="DECIMAL" property="id" />
    <result column="A_ACTIVITY_ID" jdbcType="DECIMAL" property="activityId" />
    <result column="A_USER_ID" jdbcType="DECIMAL" property="userId" />
    <result column="A_STATUS" jdbcType="VARCHAR" property="status" />
    <result column="A_RECORD_STATUS" jdbcType="CHAR" property="recordStatus" />
    <result column="A_UPDATE_COUNT" jdbcType="DECIMAL" property="updateCount" />
    <result column="A_CREATOR_ID" jdbcType="DECIMAL" property="creatorId" />
    <result column="A_CREATE_DATE" jdbcType="TIMESTAMP" property="createDate" />
    <result column="A_UPDATER_ID" jdbcType="DECIMAL" property="updaterId" />
    <result column="A_UPDATE_DATE" jdbcType="TIMESTAMP" property="updateDate" />
    <result column="A_TYPE" jdbcType="CHAR" property="type" />
    <result column="A_PROGRESS_RATE" jdbcType="VARCHAR" property="progressRate" />
    <result column="A_TOTAL_TIME" jdbcType="DECIMAL" property="totalTime" />
    <result column="A_SCORE" jdbcType="DECIMAL" property="score" />
    <result column="A_COMPLETED_DATE" jdbcType="TIMESTAMP" property="completedDate" />
    <result column="A_COMMENTS" jdbcType="VARCHAR" property="comments" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    A.ID as A_ID, A.ACTIVITY_ID as A_ACTIVITY_ID, A.USER_ID as A_USER_ID, A.STATUS as A_STATUS, 
    A.RECORD_STATUS as A_RECORD_STATUS, A.UPDATE_COUNT as A_UPDATE_COUNT, A.CREATOR_ID as A_CREATOR_ID, 
    A.CREATE_DATE as A_CREATE_DATE, A.UPDATER_ID as A_UPDATER_ID, A.UPDATE_DATE as A_UPDATE_DATE, 
    A.TYPE as A_TYPE, A.PROGRESS_RATE as A_PROGRESS_RATE, A.TOTAL_TIME as A_TOTAL_TIME, 
    A.SCORE as A_SCORE, A.COMPLETED_DATE as A_COMPLETED_DATE, A.COMMENTS as A_COMMENTS
  </sql>
  <select id="findByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    select
    <include refid="Base_Column_List" />
     from ATY_USER_ACTIVITY A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  <delete id="deleteByCriteria" parameterType="com.kingnod.core.criteria.Criteria">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    delete from ATY_USER_ACTIVITY A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
  </delete>
  <insert id="insert" parameterType="com.kingnod.etraining.activity.entity.UserActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      select ATY_USER_ACTIVITY_SEQ.nextval from dual
    </selectKey>
    insert into ATY_USER_ACTIVITY (ID, ACTIVITY_ID, USER_ID, 
      STATUS, RECORD_STATUS, UPDATE_COUNT, 
      CREATOR_ID, CREATE_DATE, UPDATER_ID, 
      UPDATE_DATE, TYPE, PROGRESS_RATE, 
      TOTAL_TIME, SCORE, COMPLETED_DATE, 
      COMMENTS)
    values (#{id,jdbcType=DECIMAL}, #{activityId,jdbcType=DECIMAL}, #{userId,jdbcType=DECIMAL}, 
      #{status,jdbcType=VARCHAR}, #{recordStatus,jdbcType=CHAR}, #{updateCount,jdbcType=DECIMAL}, 
      #{creatorId,jdbcType=DECIMAL}, #{createDate,jdbcType=TIMESTAMP}, #{updaterId,jdbcType=DECIMAL}, 
      #{updateDate,jdbcType=TIMESTAMP}, #{type,jdbcType=CHAR}, #{progressRate,jdbcType=VARCHAR}, 
      #{totalTime,jdbcType=DECIMAL}, #{score,jdbcType=DECIMAL}, #{completedDate,jdbcType=TIMESTAMP}, 
      #{comments,jdbcType=VARCHAR})
  </insert>
  <select id="countByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    select count(ID) from ATY_USER_ACTIVITY A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
  </select>
  <update id="updateByCriteria" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-10 19:18.
    -->
    update ATY_USER_ACTIVITY A
    <set>
      <if test="record.id != null">
        A.ID = #{record.id,jdbcType=DECIMAL},
      </if>
      <if test="record.activityId != null">
        A.ACTIVITY_ID = #{record.activityId,jdbcType=DECIMAL},
      </if>
      <if test="record.userId != null">
        A.USER_ID = #{record.userId,jdbcType=DECIMAL},
      </if>
      <if test="record.status != null">
        A.STATUS = #{record.status,jdbcType=VARCHAR},
      </if>
      <if test="record.recordStatus != null">
        A.RECORD_STATUS = #{record.recordStatus,jdbcType=CHAR},
      </if>
      <if test="record.updateCount != null">
        A.UPDATE_COUNT = #{record.updateCount,jdbcType=DECIMAL},
      </if>
      <if test="record.creatorId != null">
        A.CREATOR_ID = #{record.creatorId,jdbcType=DECIMAL},
      </if>
      <if test="record.createDate != null">
        A.CREATE_DATE = #{record.createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.updaterId != null">
        A.UPDATER_ID = #{record.updaterId,jdbcType=DECIMAL},
      </if>
      <if test="record.updateDate != null">
        A.UPDATE_DATE = #{record.updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.type != null">
        A.TYPE = #{record.type,jdbcType=CHAR},
      </if>
      <if test="record.progressRate != null">
        A.PROGRESS_RATE = #{record.progressRate,jdbcType=VARCHAR},
      </if>
      <if test="record.totalTime != null">
        A.TOTAL_TIME = #{record.totalTime,jdbcType=DECIMAL},
      </if>
      <if test="record.score != null">
        A.SCORE = #{record.score,jdbcType=DECIMAL},
      </if>
      <if test="record.completedDate != null">
        A.COMPLETED_DATE = #{record.completedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.comments != null">
        A.COMMENTS = #{record.comments,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
  </update>
<update id="update" parameterType="com.kingnod.etraining.activity.entity.UserActivity">
    <!--
      WARNING - @自定义修改
    -->
    update ATY_USER_ACTIVITY A
    <set>
      <if test="id != null">
        A.ID = #{id,jdbcType=DECIMAL},
      </if>
      <if test="activityId != null">
        A.ACTIVITY_ID = #{activityId,jdbcType=DECIMAL},
      </if>
      <if test="userId != null">
        A.USER_ID = #{userId,jdbcType=DECIMAL},
      </if>
      <if test="status != null">
        A.STATUS = #{status,jdbcType=VARCHAR},
      </if>
      <if test="recordStatus != null">
        A.RECORD_STATUS = #{recordStatus,jdbcType=CHAR},
      </if>
      <if test="updateCount != null">
        A.UPDATE_COUNT = #{updateCount,jdbcType=DECIMAL},
      </if>
      <if test="creatorId != null">
        A.CREATOR_ID = #{creatorId,jdbcType=DECIMAL},
      </if>
      <if test="createDate != null">
        A.CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updaterId != null">
        A.UPDATER_ID = #{updaterId,jdbcType=DECIMAL},
      </if>
      <if test="updateDate != null">
        A.UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="type != null">
        A.TYPE = #{type,jdbcType=CHAR},
      </if>
      <if test="progressRate != null">
        A.PROGRESS_RATE = #{progressRate,jdbcType=VARCHAR},
      </if>
      <if test="totalTime != null">
        A.TOTAL_TIME = #{totalTime,jdbcType=DECIMAL},
      </if>
      <if test="score != null">
        A.SCORE = #{score,jdbcType=DECIMAL},
      </if>
      <if test="completedDate != null">
        A.COMPLETED_DATE = #{completedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="comments != null">
        A.COMMENTS = #{comments,jdbcType=VARCHAR},
      </if>
    </set>
     where A.ID = #{id,jdbcType=DECIMAL}
  </update>
  <sql id="Where_ClauseByCategory">
    <!--
      WARNING -自定义
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-04-14 16:22.
    -->
      where A.ACTIVITY_ID = B.ACTIVITY_ID  AND B.type='A_EL' and
     A.Activity_Id = C.ID and
     C.COURSE_ID=D.ID and
     D.ID=E.OBJECT1_ID and C.RECORD_STATUS='A' and   E.RECORD_STATUS='A' and  A.RECORD_STATUS='A' and B.RECORD_STATUS='A' and d.record_status='A' and 
      G.FLAG_ID(+)=B.ACTIVITY_ID AND 
      nvl(G.start_date, #{params.currentDate}-1) &lt;= #{params.currentDate} 
      and nvl(G.end_date, #{params.currentDate})+1 &gt; #{params.currentDate} and 
      <foreach collection="conditions" item="condition">
        <if test="condition.group">
           ${condition.logic} 
          <foreach close=")" collection="condition.all" item="criterion" open="(">
            <choose>
              <when test="criterion.between">
                 ${criterion.expression} #{criterion.value.start} and #{criterion.value.end} 
              </when>
              <when test="criterion.list">
                 ${criterion.expression} 
                <foreach close=")" collection="criterion.value" item="inItem" open="(" separator=",">
                  #{inItem}
                </foreach>
              </when>
              <when test="criterion.none">
                 ${criterion.expression} 
              </when>
              <otherwise>
                 ${criterion.expression} #{criterion.value} 
              </otherwise>
            </choose>
          </foreach>
        </if>
        <if test="condition.group == false">
          <choose>
            <when test="condition.between">
              ${condition.expression} #{condition.value.start} and #{condition.value.end}
            </when>
            <when test="condition.list">
              ${condition.expression}
              <foreach close=")" collection="condition.value" item="inItem" open="(" separator=",">
                #{inItem}
              </foreach>
            </when>
            <when test="condition.none">
              ${condition.expression} 
            </when>
            <otherwise>
               ${condition.expression} #{condition.value} 
            </otherwise>
          </choose>
        </if>
      </foreach>
  </sql>
  <resultMap id="UserActivityListBaseResultMap" type="com.kingnod.etraining.activity.entity.UserActivitySummary">
    <!--
      WARNING - @自定义
    -->
    <id column="ID" jdbcType="DECIMAL" property="activityId" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="TYPE" jdbcType="CHAR" property="type" />
    <result column="RELEASE_DATE" jdbcType="TIMESTAMP" property="releaseDate" />
    <result column="GRADE" jdbcType="DECIMAL" property="grade" />
    <result column="COMPLETE_NUMBER" jdbcType="DECIMAL" property="completeNumber" />
     <result column="ONLINE_NUMBER" jdbcType="DECIMAL" property="onLineNumber" />
    <result column="STATUS" jdbcType="VARCHAR" property="status" />
    <result column="PROGRESS_RATE" jdbcType="VARCHAR" property="progress" />
    <result column="ENROLL_MODE" jdbcType="CHAR" property="enrollMode" />
    <result column="ENROLL_STAUTS" jdbcType="CHAR" property="enrollStatus" />
    <result column="ALLOW_LOGOUT" jdbcType="CHAR" property="allowLogout" />
  </resultMap>
  <select id="findUserActivitiesByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="UserActivityListBaseResultMap">
    <!--
      WARNING - @自定义
    -->
	SELECT B.ACTIVITY_ID ID, B.NAME, A.ACTIVITY_TYPE TYPE, B.RELEASE_DATE, B.GRADE,
	 NVL(C.STATUS,'N') STATUS,C.PROGRESS_RATE,C.COMPLETED_DATE,C.SCORE,C.TOTAL_TIME,
	  B.COMPLETE_NUMBER, B.ONLINE_NUMBER
	FROM ATY_ENROLL_LEARNER A 
  	INNER JOIN ATY_ACTIVITY B ON A.ACTIVITY_ID = B.ACTIVITY_ID
  	LEFT JOIN ATY_USER_ACTIVITY C ON A.USER_ID = C.USER_ID and A.ACTIVITY_ID = C.ACTIVITY_ID
  	LEFT JOIN ATY_PERIOD D ON A.ACTIVITY_ID = D.FLAG_ID and B.TYPE = D.FLAG_TYPE
    <if test="_parameter != null">
      <where>nvl(d.start_date, #{params.currentDate}-1) &lt;= #{params.currentDate} 
            and nvl(d.end_date, #{params.currentDate})+1 &gt; #{params.currentDate}
            and B.RELEASE_STAUTS = 'R' and  A.STAUTS = 'R'  and a.activity_type = b.type and
            <include refid="Global.Where_Clause" /> 
            
            </where>
    </if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  
    <select id="findUserActivitiesCount" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @自定义
    -->
    SELECT count(A.ACTIVITY_ID)
	FROM ATY_ENROLL_LEARNER A 
  	INNER JOIN ATY_ACTIVITY B ON A.ACTIVITY_ID = B.ACTIVITY_ID
  	LEFT JOIN ATY_USER_ACTIVITY C ON A.USER_ID = C.USER_ID and A.ACTIVITY_ID = C.ACTIVITY_ID
  	LEFT JOIN ATY_PERIOD D ON A.ACTIVITY_ID = D.FLAG_ID and B.TYPE = D.FLAG_TYPE
    <if test="_parameter != null">
      <where>
      nvl(d.start_date, #{params.currentDate}-1) &lt;= #{params.currentDate} 
            and nvl(d.end_date, #{params.currentDate})+1 &gt; #{params.currentDate}
            and B.RELEASE_STAUTS = 'R' and  A.STAUTS = 'R'  and a.activity_type = b.type and
      <include refid="Global.Where_Clause" />
       </where>
    </if>
  </select>
  
  <select id="findActivitiesByCategoryCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="UserActivityListBaseResultMap">
    <!--
      WARNING - @自定义
    -->
	SELECT distinct B.ACTIVITY_ID ID, B.NAME, B.TYPE, B.RELEASE_DATE, B.GRADE, B.COMPLETE_NUMBER, B.ONLINE_NUMBER,A.STAUTS ENROLL_STAUTS,A.ENROLL_MODE,C.ALLOW_LOGOUT 
	FROM ATY_ENROLL_LEARNER A,ATY_ACTIVITY B,ATY_ELEARNING C,crs_course_info D,CMN_OBJECT_RELATION E,ATY_PERIOD G
    <if test="_parameter != null">
      <include refid="Where_ClauseByCategory" />
    </if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  
    <select id="findActivitiesByCategoryCount" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @自定义
    -->
    SELECT count(distinct B.ACTIVITY_ID)
	FROM ATY_ENROLL_LEARNER A,ATY_ACTIVITY B,ATY_ELEARNING C,crs_course_info D,CMN_OBJECT_RELATION E,ATY_PERIOD G
    <if test="_parameter != null">
      <include refid="Where_ClauseByCategory" />
    </if>
  </select>
  
  <select id="getUserActivityByActId" parameterType="java.lang.Long" resultType="com.kingnod.etraining.activity.entity.UserActivity">
    <!--
      WARNING - @自定义 根据活动Id获取UserActivity
    -->
    select * from aty_user_activity where activity_id = #{actyId}
  </select>
</mapper>