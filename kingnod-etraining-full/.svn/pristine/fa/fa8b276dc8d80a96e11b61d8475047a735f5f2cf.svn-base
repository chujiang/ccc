<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserActivity">
 
   <resultMap id="SearchListBaseResultMap" type="com.kingnod.etraining.activity.entity.SearchResult">
    <!--
      WARNING - @自定义
    -->
    <id column="ID" jdbcType="DECIMAL" property="id" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="TYPE" jdbcType="VARCHAR" property="type" />
    <result column="DESCRIPTION" jdbcType="VARCHAR" property="desc" />
    <result column="TYPE" jdbcType="VARCHAR" property="type" />
    <result column="RELEASE_DATE" jdbcType="TIMESTAMP" property="releaseDate" />
    <result column="GRADE" jdbcType="DECIMAL" property="grade" />
    <result column="ENROLL_MODE" jdbcType="CHAR" property="enrollMode" />
    <result column="ENROLL_STAUTS" jdbcType="CHAR" property="enrollStatus" />
    <result column="COURSE_ID" jdbcType="DECIMAL" property="courseId" />
    <result column="IMP_PATH" jdbcType="VARCHAR" property="imagePath" />
    <result column="allowLogout" jdbcType="VARCHAR" property="ALLOW_LOGOUT" />
    <result column="C_ATTACHMENT_ID" jdbcType="VARCHAR" property="attachmentId" />
    <result column="ATY_TIME" jdbcType="DECIMAL" property="atyTime" />
    
  </resultMap>
  
  <sql id="Where_ClauseBySearch">
    <!--
      WARNING -自定义
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-04-14 16:22.
    -->
      <foreach collection="conditions" item="condition">
        <if test="condition.group">
           ${condition.logic} 
          <foreach close=")" collection="condition.all" item="criterion" open="(">
            <choose>
              <when test="criterion.between">
                 ${criterion.expression} #{criterion.value.start} and #{criterion.value.end} 
              </when>
              <when test="criterion.list">
                 ${criterion.expression} 
                <foreach close=")" collection="criterion.value" item="inItem" open="(" separator=",">
                  #{inItem}
                </foreach>
              </when>
              <when test="criterion.none">
                 ${criterion.expression} 
              </when>
              <otherwise>
                 ${criterion.expression} #{criterion.value} 
              </otherwise>
            </choose>
          </foreach>
        </if>
        <if test="condition.group == false">
          <choose>
            <when test="condition.between">
              ${condition.expression} #{condition.value.start} and #{condition.value.end}
            </when>
            <when test="condition.list">
              ${condition.expression}
              <foreach close=")" collection="condition.value" item="inItem" open="(" separator=",">
                #{inItem}
              </foreach>
            </when>
            <when test="condition.none">
              ${condition.expression} 
            </when>
            <otherwise>
               ${condition.expression} #{condition.value} 
            </otherwise>
          </choose>
        </if>
      </foreach>
  </sql>
 
  
  <select id="findActivitiesByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="SearchListBaseResultMap">
    <!--
      WARNING - @自定义
    -->
	SELECT A.ACTIVITY_ID ID, A.NAME,A.TYPE,A.GRADE,D.ENROLL_MODE,D.STAUTS ENROLL_STAUTS,A.RELEASE_DATE,B.COURSE_ID,C.ATTACHMENT_ID as C_ATTACHMENT_ID,C.DESCRIPTION,B.ALLOW_LOGOUT 
  FROM ATY_ACTIVITY A, ATY_ELEARNING B,CRS_COURSE_INFO C,ATY_ENROLL_LEARNER D,ATY_PERIOD G
    <if test="_parameter != null">
      WHERE D.ACTIVITY_ID = B.ID  and B.COURSE_ID=C.ID and A.ACTIVITY_ID=B.ID and 
       B.RECORD_STATUS = 'A' and C.RECORD_STATUS = 'A' and C.RELEASE_STATUS = 'R' and B.RELEASE_STAUTS='R' and  a.record_status='A' and d.record_status='A' and 
       G.FLAG_ID(+)=A.ACTIVITY_ID AND 
       nvl(G.start_date, #{params.currentDate}-1) &lt;= #{params.currentDate} 
       and nvl(G.end_date, #{params.currentDate})+1 &gt; #{params.currentDate} and 
      <include refid="Where_ClauseBySearch" />
    </if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
  
    
      
    <select id="findActivitiesByCriteriaCount" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @自定义
    -->
    SELECT count(A.ACTIVITY_ID) 
    FROM ATY_ACTIVITY A, ATY_ELEARNING B,CRS_COURSE_INFO C,ATY_ENROLL_LEARNER D,ATY_PERIOD G
    <if test="_parameter != null">
      WHERE D.ACTIVITY_ID = B.ID  and B.COURSE_ID=C.ID and A.ACTIVITY_ID=B.ID and 
      B.RECORD_STATUS = 'A' and C.RECORD_STATUS = 'A' and C.RELEASE_STATUS = 'R' and B.RELEASE_STAUTS='R' and a.record_status='A' and d.record_status='A' and 
       G.FLAG_ID(+)=A.ACTIVITY_ID AND 
       nvl(G.start_date, #{params.currentDate}-1) &lt;= #{params.currentDate} 
       and nvl(G.end_date, #{params.currentDate})+1 &gt; #{params.currentDate} and 
      <include refid="Where_ClauseBySearch" />
    </if>
  </select>
  
  
  
    
  <select id="searchByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="SearchListBaseResultMap">
    <!--
      WARNING - @自定义
    -->
	SELECT A.ACTIVITY_ID ID, A.NAME,A.TYPE,A.GRADE,A.RELEASE_DATE,
	D.ENROLL_MODE,D.STAUTS ENROLL_STAUTS,B.REMARKS DESCRIPTION,B.ATY_TIME
	FROM ATY_ACTIVITY A
	INNER JOIN ATY_EXAMINATION B ON A.ACTIVITY_ID = B.ID
	INNER JOIN ATY_ENROLL_LEARNER D ON B.ID = D.ACTIVITY_ID
	LEFT JOIN ATY_USER_ACTIVITY E ON D.ACTIVITY_ID = E.ACTIVITY_ID
    <if test="_parameter != null">
	WHERE B.RECORD_STATUS = 'A' AND B.RECORD_STATUS = 'A' AND D.EXCLUDED = '0' 
    AND B.PUBLISH_STATUS = 'R' AND
    <include refid="Where_ClauseBySearch" />
    </if>
    <if test="hasOrderBy">
     order by
    <foreach collection="orderBys" item="orderBy" separator=",">
      ${orderBy}
    </foreach>
    </if>
  </select>
  
    
      
    <select id="searchByCriteriaCount" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @自定义
    -->
    SELECT count(A.ACTIVITY_ID) 
   FROM ATY_ACTIVITY A
	INNER JOIN ATY_EXAMINATION B ON A.ACTIVITY_ID = B.ID
	INNER JOIN ATY_ENROLL_LEARNER D ON B.ID = D.ACTIVITY_ID
	LEFT JOIN ATY_USER_ACTIVITY E ON D.ACTIVITY_ID = E.ACTIVITY_ID
    <if test="_parameter != null">
	WHERE B.RECORD_STATUS = 'A' AND B.RECORD_STATUS = 'A' AND D.EXCLUDED = '0' 
    AND B.PUBLISH_STATUS = 'R' AND
    <include refid="Where_ClauseBySearch" />
    </if>
  </select>
  
</mapper>