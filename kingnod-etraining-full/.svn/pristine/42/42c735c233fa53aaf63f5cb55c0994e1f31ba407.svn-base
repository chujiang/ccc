<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ExaminationStat">
  <resultMap id="BaseResultMap" type="com.kingnod.etraining.report.entity.ExaminationStat">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-22 20:45.
    -->
    <result column="A_EXAMINATION_ID" jdbcType="DECIMAL" property="examinationId" />
    <result column="A_EXAMINATION_NAME" jdbcType="VARCHAR" property="examinationName" />
    <result column="A_PAPER_NAME" jdbcType="VARCHAR" property="paperName" />
    <result column="A_PAPER_TOTAL_SCORE" jdbcType="DECIMAL" property="paperTotalScore" />
    <result column="A_ATY_TIME" jdbcType="DECIMAL" property="atyTime" />
    <result column="A_SCORING_TYPE" jdbcType="VARCHAR" property="scoringType" />
    <result column="A_PASS_SCORE" jdbcType="DECIMAL" property="passScore" />
    <result column="A_START_DATE" jdbcType="DATE" property="startDate" />
    <result column="A_ALL_REGISTERS" jdbcType="DECIMAL" property="allRegisters" />
    <result column="A_EXAMED_COUNT" jdbcType="DECIMAL" property="examedCount" />
    <result column="A_PASS_COUNT" jdbcType="DECIMAL" property="passCount" />
    <result column="A_AVG_SCORE" jdbcType="DECIMAL" property="avgScore" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-22 20:45.
    -->
    A.EXAMINATION_ID as A_EXAMINATION_ID, A.EXAMINATION_NAME as A_EXAMINATION_NAME, A.PAPER_NAME as A_PAPER_NAME, 
    A.PAPER_TOTAL_SCORE as A_PAPER_TOTAL_SCORE, A.ATY_TIME as A_ATY_TIME, A.SCORING_TYPE as A_SCORING_TYPE, 
    A.PASS_SCORE as A_PASS_SCORE, A.START_DATE as A_START_DATE, A.ALL_REGISTERS as A_ALL_REGISTERS, 
    A.EXAMED_COUNT as A_EXAMED_COUNT, A.PASS_COUNT as A_PASS_COUNT,A.AVG_SCORE A_AVG_SCORE
  </sql>
  <sql id="Base_Table">
  (
  select b.examination_id ,
       b.examination_name ,
       b.paper_name , 
       b.paper_total_score , 
       b.aty_time,
       b.scoring_type,
       b.pass_score,
       b.start_date,
	   b.site_id,
       a.examed_count+b.registers all_registers,      
       a.examed_count,
       a.pass_count,
       a.avg_score
  from (
  select examination_id,
       count(1) examed_count,
       sum(
       case 
       when final_score &gt;= (select nvl(pass_score,0) from aty_examination where id=examination_id) then 1
       else 0
       end ) pass_count,
       sum(final_score)/count(1) avg_score
  from (
        select ah.examination_id,
                       ah.user_id,
                       ah.exam_Times,
                       case (select SCORING_TYPE from aty_examination where id=ah.examination_id)
                       when 'A' then ah.sum_score / ah.exam_Times  
                       when 'H' then ah.max_score
                       else 
                           (select to_number(nvl(totalScore, 0))
                          from aty_examinees_history rowAH
                         where rowAH.Examination_Id = ah.examination_id
                           and rowAH.User_Id = ah.user_id
                           and rowAH.Times = ah.exam_Times)      
                       end final_score
                  from (select examination_id,
                               user_id,
                               count(*) exam_Times,                       
                               max(nvl(totalScore,0)) max_score,
                               sum(nvl(totalScore,0)) sum_score
                          from aty_examinees_history
                         where record_status='A'
                         group by examination_id, user_id) ah )
        group by examination_id  
                 ) a,
       (select a1.name examination_name,
               a1.id examination_id,
               a1.reexam_times,
               a2.total_score paper_total_score,
               a2.name paper_name,
               a1.scoring_type,
               a1.pass_score,
               a1.aty_time,
               a2.total_score ,
               ap.start_date,
               ael.registers,
               af.site_id
        
          from aty_examination a1          
          left join aty_period ap on ap.flag_id=a1.id and ap.flag_type='A_XN'
          left join exm_exam_paper a2 on a1.aty_paper_id = a2.id
          left join (select activity_id,count(1) registers from aty_enroll_learner t group by activity_id) ael on ael.activity_id =a1.id 
          left join ATY_FOLDER af on af.id=a1.FOLDER_ID
         where a1.record_status='A'
         ) b 
 	where a.examination_id = b.examination_id  
  	)
  </sql>
  <select id="findByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-22 20:45.
    -->
    select
    <include refid="Base_Column_List" />
     from <include refid="Base_Table" /> A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
    <if test="hasOrderBy">
      order by
      <foreach collection="orderBys" item="orderBy" separator=",">
        ${orderBy}
      </foreach>
    </if>
  </select>
   
   
  <select id="countByCriteria" parameterType="com.kingnod.core.criteria.Criteria" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on 2012-05-22 20:45.
    -->
    select count(*) from <include refid="Base_Table" /> A
    <if test="_parameter != null">
      <where>
        <include refid="Global.Where_Clause" />
      </where>
    </if>
  </select>
  
   
</mapper>